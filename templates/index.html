{% extends 'base.html' %}

{% block title %}{{ config.nome_site }} - In√≠cio{% endblock %}

{% block content %}
<div id="painelPrincipal" class="fade-in">
    
    <div id="blocoComandoIA" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-8">
        <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
            <label class="block text-gray-800 font-bold text-lg flex items-center gap-2">
                ‚ö° Painel de Controle
            </label>
            <span class="bg-green-100 text-green-700 text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wider">Admin</span>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <button onclick="iniciarCadastro()" class="btn-primary py-3 rounded-lg font-bold flex items-center justify-center gap-2"><span>Ôºã</span> Cadastrar</button>
            <button onclick="solicitarId('alterar')" class="bg-gray-100 text-gray-700 hover:bg-gray-200 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2"><span>‚úèÔ∏è</span> Editar</button>
            <button onclick="solicitarId('vendido')" class="bg-purple-100 text-purple-700 hover:bg-purple-200 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2"><span>ü§ù</span> Vendido</button>
            <button onclick="solicitarId('remover')" class="bg-red-50 text-red-600 hover:bg-red-100 py-3 rounded-lg font-bold transition flex items-center justify-center gap-2"><span>üóëÔ∏è</span> Excluir</button>
        </div>
        
        <div class="relative">
            <input type="text" id="comandoTexto" placeholder="IA: Digite aqui para cadastrar r√°pido (Ex: 'Vender fazenda de 500ha...')" class="w-full bg-gray-50 border border-gray-200 p-4 pl-12 rounded-xl outline-none focus:border-green-500 focus:bg-white focus:ring-2 focus:ring-green-100 transition shadow-inner">
            <span class="absolute top-4 left-4 text-xl grayscale opacity-50">ü§ñ</span>
            <button onclick="enviarComando()" id="btnEnviar" class="absolute top-2 right-2 bg-gray-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-black transition text-sm">Enviar</button>
        </div>
    </div>

    <div class="flex justify-between items-center mb-8 mt-4">
        <div>
            <h2 class="text-3xl font-bold text-gray-900 tracking-tight">Im√≥veis Recentes</h2>
            <p class="text-gray-500 text-sm mt-1">Confira as melhores oportunidades cadastradas.</p>
        </div>
        
        {% set disponiveis = imoveis | selectattr('status', 'ne', 'vendido') | list | length %}
        
        <span class="bg-white border border-gray-200 text-gray-600 px-4 py-1 rounded-full text-sm font-bold shadow-sm">
            {{ disponiveis }} Im√≥veis Dispon√≠veis
        </span>
    </div>

    {% if imoveis %}
    <div id="gridImoveis" class="grid grid-cols-1 md:grid-cols-3 gap-8 pb-12">
        {% for imovel in imoveis %}
        
        <div id="card-{{ imovel.id }}" 
             class="imovel-card bg-white rounded-2xl overflow-hidden hover:shadow-xl transition-all duration-300 border border-gray-200 group flex flex-col h-full relative {{ 'status-vendido' if imovel.status == 'vendido' else 'status-disponivel' }}" 
             data-id="{{ imovel.id }}"
             data-galeria='{{ imovel.galeria | tojson }}'>
            
            <div class="relative h-64 overflow-hidden bg-gray-100 group-img">
                <img id="img-{{ imovel.id }}" src="{{ imovel.galeria[0] }}" data-index="0"
                     class="h-full w-full object-cover transition duration-500"
                     onerror="this.src='https://via.placeholder.com/800x400?text=Sem+Foto'">
                
                <div class="absolute top-4 left-4 bg-gray-900/80 backdrop-blur text-white px-3 py-1 rounded-md text-xs font-bold uppercase tracking-wide z-10">
                    {{ imovel.tipo }}
                </div>

                {% if imovel.status != 'vendido' %}
                <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-30">
                    
                    <a href="https://wa.me/{{ config.telefone }}?text=Ol√°, tenho interesse no im√≥vel ID {{ imovel.id }}: {{ imovel.titulo }}" target="_blank" class="bg-white text-green-500 p-2 rounded-full shadow-lg hover:bg-green-500 hover:text-white hover:scale-110 transition flex items-center justify-center" title="Conversar no WhatsApp">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.897.003-6.166 5.018-11.183 11.178-11.183 2.979.002 5.798 1.16 7.904 3.268 2.106 2.108 3.263 4.927 3.265 7.908.002 6.165-5.016 11.182-11.175 11.182-1.928 0-3.824-.492-5.492-1.425l-5.78 1.51zm9.239-12.915c-.156-.255-.572-.395-.91-.219-.153.08-1.744 1.144-1.91 1.272-.259.199-.548.513-.424.839.231.605 1.584 2.919 3.52 4.606 1.936 1.686 4.39 1.64 4.887 1.352.417-.242 1.488-1.295 1.488-1.295.385-.436.082-.94-.337-1.148-1.124-.559-2.222-1.076-2.222-1.076-.474-.226-.957-.042-1.238.318l-.517.653c-.158.201-.52.274-.848.127-.852-.381-2.164-1.472-2.584-2.19z"/></svg>
                    </a>

                    <button onclick="compartilharImovel('{{ request.url_root }}imovel/{{ imovel.id }}')" class="bg-white text-gray-500 p-2 rounded-full shadow-lg hover:bg-blue-500 hover:text-white hover:scale-110 transition flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                    </button>
                    
                    <button onclick="favoritarImovel({{ imovel.id }}, this)" class="btn-favorito bg-white p-2 rounded-full hover:bg-red-50 text-gray-400 shadow-md transition-colors group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                    </button>
                </div>
                {% endif %}

                <div class="absolute inset-0 flex items-center justify-between px-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 pointer-events-none">
                    <button onclick="mudarFoto(event, {{ imovel.id }}, -1)" class="pointer-events-auto bg-black/50 hover:bg-black/80 text-white p-2 rounded-full backdrop-blur-sm transition transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <button onclick="mudarFoto(event, {{ imovel.id }}, 1)" class="pointer-events-auto bg-black/50 hover:bg-black/80 text-white p-2 rounded-full backdrop-blur-sm transition transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                    </button>
                </div>

                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 pt-12 z-10">
                    <p class="text-white font-bold text-xl text-shadow">
                        {% if imovel.status == 'vendido' %}
                            <span class="opacity-80">Vendido</span>
                        {% else %}
                            R$ {{ "{:,.0f}".format(imovel.preco|float).replace(",", ".") }}
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="p-5 flex-1 flex flex-col">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold text-lg text-gray-800 leading-tight mb-2 line-clamp-1 group-hover:text-green-700 transition">{{ imovel.titulo }}</h3>
                    <span class="text-xs text-gray-400 font-mono">#{{ imovel.id }}</span>
                </div>
                
                <p class="text-gray-500 text-sm line-clamp-2 mb-4 flex-1">{{ imovel.descricao }}</p>

                <div class="flex items-center gap-4 text-sm text-gray-600 border-t border-gray-100 pt-3">
                    <span class="flex items-center gap-1 font-medium bg-gray-50 px-2 py-1 rounded">
                        üìê {{ imovel.area }} {{ imovel.tipo_medida }}
                    </span>
                    <span class="flex items-center gap-1 font-medium truncate">
                        üìç {{ imovel.cidade }}
                    </span>
                </div>
                
                <a href="/imovel/{{ imovel.id }}" target="_blank" class="mt-4 block w-full text-center bg-white border border-gray-300 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-50 hover:border-green-600 hover:text-green-700 transition text-sm">
                    Ver Detalhes
                </a>
            </div>

            {% if imovel.status == 'vendido' %}
            <div class="absolute inset-0 bg-white/70 z-20 flex items-center justify-center pointer-events-none">
                <div class="bg-gray-900 text-white px-8 py-3 rounded shadow-2xl font-black text-xl uppercase tracking-widest border-2 border-gray-900 transform -rotate-6">
                    Vendido
                </div>
            </div>
            {% endif %}

        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="flex flex-col items-center justify-center py-20 bg-white rounded-2xl border border-gray-200 shadow-sm">
        <div class="text-6xl mb-4 grayscale opacity-20">üè°</div>
        <h3 class="text-xl font-bold text-gray-800">Nenhum im√≥vel encontrado</h3>
        <p class="text-gray-500">Utilize o painel para cadastrar a primeira oferta.</p>
    </div>
    {% endif %}

    <div id="modalId" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm text-center shadow-2xl relative">
            <button onclick="document.getElementById('modalId').classList.add('hidden')" class="absolute top-2 right-4 text-gray-400 hover:text-red-500 text-xl font-bold">‚úï</button>
            <h3 class="text-lg font-bold text-gray-800 mb-4" id="tituloModalId">Informe o ID</h3>
            <input type="number" id="inputImovelId" class="w-full border-2 border-gray-200 p-3 rounded-lg text-center text-xl font-bold mb-6 outline-none focus:border-green-500 transition" placeholder="Ex: 10">
            <button onclick="confirmarAcaoId()" class="w-full btn-primary py-3 rounded-lg font-bold shadow-lg">Confirmar</button>
        </div>
    </div>

    <script>
        // 1. OBT√âM DADOS LIMPOS
        function getFavoritos() {
            const salvos = JSON.parse(localStorage.getItem('favoritosAgro') || '[]');
            // For√ßa tudo a ser n√∫mero para evitar duplicatas "10" vs 10
            return [...new Set(salvos.map(id => parseInt(id)).filter(id => !isNaN(id)))];
        }

        // 2. SALVA
        function salvarFavoritos(lista) {
            localStorage.setItem('favoritosAgro', JSON.stringify(lista));
        }

        // 3. ATUALIZA A INTERFACE INTEIRA (Fonte da Verdade)
        // Essa fun√ß√£o garante que o visual SEMPRE bata com o dado salvo
        function atualizarBotoes() {
            const favoritos = getFavoritos();
            
            // Pega TODOS os bot√µes de cora√ß√£o da tela
            const todosBotoes = document.querySelectorAll('.btn-favorito');
            
            todosBotoes.forEach(btn => {
                // Pega o ID do bot√£o (extra√≠do do id="btn-fav-10")
                const idImovel = parseInt(btn.id.replace('btn-fav-', ''));
                
                if (favoritos.includes(idImovel)) {
                    // SE √â FAVORITO: Pinta de Vermelho
                    btn.classList.add('text-red-500');
                    btn.classList.remove('text-gray-400');
                } else {
                    // SE N√ÉO √â: Pinta de Cinza
                    btn.classList.remove('text-red-500');
                    btn.classList.add('text-gray-400');
                }
            });
        }

        // 4. A√á√ÉO DO CLIQUE
        function toggleFavorito(id) {
            const idNumerico = parseInt(id);
            let favoritos = getFavoritos();
            
            // L√≥gica "Nuclear": Filtra para remover (mais seguro que splice)
            const novaLista = favoritos.filter(fId => fId !== idNumerico);
            
            if (novaLista.length < favoritos.length) {
                // Se o tamanho diminuiu, √© porque REMOVEU
                favoritos = novaLista;
            } else {
                // Se o tamanho √© igual, n√£o tinha, ent√£o ADICIONA
                favoritos.push(idNumerico);
            }

            salvarFavoritos(favoritos);
            
            // Atualiza visual e ordena
            atualizarBotoes(); 
            setTimeout(reordenarGrid, 100); // Pequeno delay para garantir fluidez
        }

        // 5. REORDENA√á√ÉO
        function reordenarGrid() {
            const grid = document.getElementById('gridImoveis');
            if(!grid) return;

            const favoritos = getFavoritos();
            const cards = Array.from(grid.children);

            cards.sort((a, b) => {
                const idA = parseInt(a.dataset.id);
                const idB = parseInt(b.dataset.id);
                
                const isFavA = favoritos.includes(idA);
                const isFavB = favoritos.includes(idB);
                
                const isVendidoA = a.classList.contains('status-vendido');
                const isVendidoB = b.classList.contains('status-vendido');

                if (isVendidoA && !isVendidoB) return 1;
                if (!isVendidoA && isVendidoB) return -1;
                if (isFavA && !isFavB) return -1;
                if (!isFavA && isFavB) return 1;
                return idB - idA; 
            });

            cards.forEach(card => grid.appendChild(card));
        }

        // 6. FUN√á√ïES DE FOTO
        function mudarFoto(event, id, direcao) {
            event.preventDefault(); event.stopPropagation();
            const card = document.getElementById('card-' + id);
            const img = document.getElementById('img-' + id);
            const galeria = JSON.parse(card.dataset.galeria);
            let indexAtual = parseInt(img.dataset.index);
            let novoIndex = indexAtual + direcao;
            if (novoIndex >= galeria.length) novoIndex = 0;
            if (novoIndex < 0) novoIndex = galeria.length - 1;
            img.src = galeria[novoIndex];
            img.dataset.index = novoIndex;
        }

        // 7. INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', () => {
            atualizarBotoes(); // Pinta correto ao abrir
            reordenarGrid();   // Ordena correto ao abrir
        });
    </script>
</div>
{% endblock %}